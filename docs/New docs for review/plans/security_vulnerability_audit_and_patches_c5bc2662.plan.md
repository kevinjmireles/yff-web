---
name: Security Vulnerability Audit and Patches
overview: Comprehensive security audit identifying 10+ vulnerabilities across authentication, authorization, rate limiting, and edge function security. Plan includes prioritized fixes with specific code changes.
todos: []
---

# Security Vulnerability Audit and Remediation Plan

## Executive Summary

This audit identified **13 critical and high-priority security vulnerabilities** requiring immediate attention. The most severe issues include a critical Next.js dependency vulnerability, authentication bypasses, and rate limiting gaps.

**Status Update**: ✅ Next.js upgrade (Item #0) has been completed and validated. See validation report at `docs/review/NEXTJS_UPGRADE_VALIDATION.md`.

## Critical Vulnerabilities (P0 - Fix Immediately)

### 0. Next.js Dependency Vulnerabilities (CVE-2025-55184, CVE-2025-55183) ✅ **COMPLETED**

**Location**: `package.json` (Next.js 15.5.7 → 15.5.9)

**Issue**: Project was using Next.js 15.5.7, which was vulnerable to:

- **CVE-2025-55184** (High Severity - DoS): Specially crafted HTTP requests can cause infinite loops that hang the server process
- **CVE-2025-55183** (Medium Severity - Source Code Exposure): Specially crafted requests can cause Server Functions to return compiled source code, potentially exposing business logic and secrets

**Risk**: Critical - Can cause denial of service attacks and expose source code/secrets

**Fix**: ✅ **COMPLETED** - Upgraded to Next.js 15.5.9

**Reference**: [Next.js Security Update December 11, 2025](https://nextjs.org/blog/security-update-2025-12-11)

**Completion Details**:
- ✅ Next.js upgraded from 15.5.7 to 15.5.9
- ✅ eslint-config-next upgraded from 15.5.7 to 15.5.9
- ✅ Build verified: All 21 routes generated successfully
- ✅ Tests verified: 86/86 core tests passing
- ✅ No breaking changes detected
- ✅ Validation report: `docs/review/NEXTJS_UPGRADE_VALIDATION.md`

**Status**: Ready for production deployment

### 1. Admin Login Brute Force Vulnerability

**Location**: `src/app/api/admin/login/route.ts`

**Issue**: No rate limiting on admin login endpoint, allowing unlimited brute force attempts

**Risk**: High - Attackers can guess admin password without restrictions

**Fix**: Add rate limiting (5 attempts per 15 minutes per IP)

### 2. Edge Function Authentication Bypass

**Location**: `supabase/functions/profile-address-v2/index.ts:28-30`

**Issue**: Authentication check is commented out with `// TEMPORARY: Skip authentication for debugging`

**Risk**: Critical - Edge function is publicly accessible without authentication

**Fix**: Re-enable authentication check immediately

### 3. Weak Admin Cookie Value

**Location**: `src/app/api/admin/login/route.ts:17`

**Issue**: Cookie value is just `'1'` - easily guessable and forgeable

**Risk**: High - Attackers could forge admin sessions

**Fix**: Use cryptographically secure random session token stored server-side

## High Priority Vulnerabilities (P1 - Fix This Week)

### 4. Missing Rate Limiting on Admin Endpoints

**Location**: All `/api/admin/*` and `/api/send/*` routes

**Issue**: No rate limiting on sensitive admin operations

**Risk**: Medium-High - Enables DoS and abuse

**Fix**: Add rate limiting middleware for admin endpoints

### 5. Missing Security Headers

**Location**: `next.config.mjs`

**Issue**: No security headers (CSP, X-Frame-Options, X-Content-Type-Options, etc.)

**Risk**: Medium - Vulnerable to XSS, clickjacking, MIME sniffing

**Fix**: Add comprehensive security headers

### 6. No CSRF Protection

**Location**: All state-changing API routes

**Issue**: No CSRF token validation for POST/PUT/DELETE operations

**Risk**: Medium - Vulnerable to cross-site request forgery

**Fix**: Implement CSRF token validation for state-changing operations

### 7. Admin Password in Plain Text

**Location**: `src/app/api/admin/login/route.ts:10`

**Issue**: Password compared directly from env var (no hashing)

**Risk**: Medium - If env var leaked, password is exposed

**Fix**: Use bcrypt/argon2 for password hashing (even for single admin)

### 8. Test Access Token Exposure in URL

**Location**: `src/app/api/test-auth/route.ts:12`

**Issue**: Token passed as URL parameter, could leak in logs/browser history

**Risk**: Medium - Token could be exposed in access logs

**Fix**: Use POST with body or header instead of GET with query param

## Medium Priority Vulnerabilities (P2 - Fix This Month)

### 9. Missing Request Size Limits

**Location**: All API routes

**Issue**: No enforcement of request body size limits

**Risk**: Low-Medium - Could enable DoS via large payloads

**Fix**: Add request size limits (e.g., 1MB for JSON, 10MB for file uploads)

### 10. RLS Policies Too Permissive

**Location**: `supabase/policies/canonical_v2_1_policies.sql:21-55`

**Issue**: Service role policies use `USING (true)` - allows all operations

**Risk**: Low-Medium - If service key leaked, full database access

**Fix**: Review and tighten service role policies where possible (note: service role bypasses RLS by design, but document this clearly)

### 11. Missing Input Validation on Some Endpoints

**Location**: Various API routes

**Issue**: Some endpoints may not validate all inputs thoroughly

**Risk**: Low-Medium - Could enable injection or data corruption

**Fix**: Audit all endpoints, ensure Zod validation on all inputs

### 12. In-Memory Rate Limiting (Not Production-Ready)

**Location**: `src/lib/rateLimiter.ts`

**Issue**: In-memory rate limiting resets on server restart, doesn't work across instances

**Risk**: Low - Works for single instance but not scalable

**Fix**: Document limitation, plan migration to Redis for production

## Implementation Plan

### Phase 1: Critical Fixes (Immediate)

0. ✅ **UPGRADE NEXT.JS** - Upgrade from 15.5.7 to 15.5.9 (fixes CVE-2025-55184 and CVE-2025-55183) - **COMPLETED**
1. Re-enable edge function authentication
2. Add rate limiting to admin login
3. Implement secure admin session tokens

### Phase 2: High Priority (This Week)

4. Add security headers
5. Implement CSRF protection
6. Add rate limiting to admin endpoints
7. Move test-auth to POST

### Phase 3: Medium Priority (This Month)

8. Add request size limits
9. Audit and improve input validation
10. Document RLS policy strategy
11. Plan Redis migration for rate limiting

## Files to Modify

- ✅ `package.json` - **COMPLETED**: Upgraded Next.js from 15.5.7 to 15.5.9
- `src/app/api/admin/login/route.ts` - Add rate limiting, secure sessions
- `supabase/functions/profile-address-v2/index.ts` - Re-enable auth
- `next.config.mjs` - Add security headers
- `middleware.ts` - Add CSRF protection, rate limiting
- `src/lib/auth.ts` - Implement secure session management
- `src/app/api/test-auth/route.ts` - Change to POST
- `src/lib/rateLimiter.ts` - Document limitations, add Redis option

## Testing Requirements

- ✅ **Verify Next.js upgrade**: ✅ COMPLETED - Version 15.5.9 installed, build successful, 86/86 tests passing (see `docs/review/NEXTJS_UPGRADE_VALIDATION.md`)
- Test rate limiting on admin login (should block after 5 attempts)
- Verify edge function requires authentication
- Test CSRF protection on state-changing operations
- Verify security headers are present
- Test secure session token generation and validation

## Progress Summary

**Completed**: 1 of 13 vulnerabilities (8%)
- ✅ Item #0: Next.js upgrade (CVE-2025-55184, CVE-2025-55183)

**Remaining Critical (P0)**: 2 vulnerabilities
- Item #1: Admin login brute force protection
- Item #2: Edge function authentication bypass
- Item #3: Weak admin cookie value

**Remaining High Priority (P1)**: 4 vulnerabilities
**Remaining Medium Priority (P2)**: 4 vulnerabilities